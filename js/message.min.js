function populateNewMessage(){var e=document.getElementById("hidden_usergroupcde").value;switch(e){case"ADM":var t=document.getElementById("hidden_touserid").value;document.getElementById("select_to_username").value=t;break;case"COR":var t=document.getElementById("hidden_touserid").value;document.getElementById("select_to_username").value=t;break;case"HIK":var n=document.getElementById("hidden_tousername").value,a=document.getElementById("hidden_touserusername").value;document.getElementById("textbox_to_username").value=n+" ("+a+")"}}function newMessage(){destroyEditor();var e=document.getElementById("template_newMessage").innerHTML;if(document.getElementById("div_messages_main").innerHTML=e,$("#downloader").downloader({desc:!0}),"HIK"===document.getElementById("hidden_usergroupcde").value){var t=document.getElementById("hidden_coruserid").value,n=document.getElementById("hidden_corusername").value,a=document.getElementById("hidden_coruserusername").value,s=document.getElementById("hidden_coruseremail").value;document.getElementById("hidden_touserid").value=t,document.getElementById("hidden_touseremail").value=s,document.getElementById("textbox_to_username").value=n+" ("+a+")"}else{var d=document.getElementById("select_to_username");d.disabled=!1,document.getElementById("hidden_touserid").value=document.getElementById("select_to_username").children[0].value,$(d).change(function(){document.getElementById("hidden_touserid").value=this.value})}initEditor()}function reply(){var e=document.getElementById("hidden_viewfromid").value,t=document.getElementById("hidden_viewmessageid").value,n=document.getElementById("span_messagefromusername").innerHTML,a=document.getElementById("hidden_viewtoid").value,s=document.getElementById("span_messagetousername").innerHTML,d=document.getElementById("span_messagesubject").innerHTML,i=document.getElementById("span_messagedte").innerHTML,o=document.getElementById("span_messagecontent").innerHTML;if(e!=document.getElementById("hidden_userid").value){var l=a;a=e,e=l,l=s,s=n,n=l}var r="<br /><br /><br />---------------------<br />";r+="From: "+n+"<br />",r+="To: "+s+"<br />",r+="Date: "+i+"<br /><br />",r+=o;var m=document.getElementById("template_newMessage").innerHTML;if(document.getElementById("div_messages_main").innerHTML=m,$("#downloader").downloader({desc:!0}),"HIK"==document.getElementById("hidden_usergroupcde").value)document.getElementById("textbox_to_username").value=s;else{var c=document.getElementById("select_to_username");c.value=a,$(c).change(function(){document.getElementById("hidden_touserid").value=this.value})}document.getElementById("legend_newMessageReply").innerHTML="Reply",document.getElementById("textbox_subject").value="RE: "+d,document.getElementById("textbox_message").value=r,document.getElementById("hidden_touserid").value=a,document.getElementById("hidden_replymessageid").value=t,initEditor()}function cancelMessage(){document.getElementById("div_messages_main").innerHTML="",destroyEditor()}function message_markRead(e,t,n){if(-1!==document.getElementById("h4_folderName").innerHTML.indexOf("Inbox")){$.post("includes/messageMarkRead",{ADK_MESSAGE_ID:e},function(){t&&t.classList.remove("font-bold"),n&&n.setAttribute("data-isread","true")});var a=document.getElementById("span_messages").children[0];a&&(a.innerHTML=parseInt(a.innerHTML)-1,0==a.innerHTML&&(a.outerHTML=""))}}function viewMessage(e){"undefined"!=typeof editor&&editor.destroy();var t=document.getElementById("div_messages_main");$.post("includes/messageGet.php",{ADK_MESSAGE_ID:e},function(e){t.innerHTML="",t.innerHTML=document.getElementById("template_viewMessage").innerHTML;var n=JSON.parse(e);document.getElementById("span_messagefromusername").innerHTML=n.fromname+" ("+n.fromusername+")",document.getElementById("span_messagetousername").innerHTML=n.toname+" ("+n.tousername+")",document.getElementById("span_messagesubject").innerHTML=n.title,document.getElementById("span_messagedte").innerHTML=n.date+"&nbsp;"+n.time,document.getElementById("span_messagecontent").innerHTML=n.content,document.getElementById("hidden_viewmessageid").value=n.id,document.getElementById("hidden_viewfromid").value=n.fromid,document.getElementById("hidden_viewtoid").value=n.toid,1===n.fromid?document.getElementById("button_reply").style.display="none":document.getElementById("button_reply").style.display="";var a=document.getElementById("ul_messageattachments");if(""!==n.files){for(var s="",d=n.files,i=0;i<d.length;i++)s+='<li><a class="pointer hoverbtn" data-id="'+d[i].id+'" data-desc="'+d[i].desc+'" data-size="'+d[i].size+'" onclick="getFile('+d[i].id+');">'+d[i].name+"</a></li>";a.innerHTML=s}else a.innerHTML='<li style="font-style:italic;">none</li>';var o=document.getElementById("a_loghike");o&&(n.isfromhiker?o.setAttribute("href","./hiker?_="+n.fromid+"&m="+n.id):o.style.display="none")})}function sortMessages(e){function t(e,t){return e.n<t.n?-1:e.n>t.n?1:0}function n(e,t){function n(e){var t=[],n=e.split(" ")[0].split("/"),a=e.split(" ")[1].split(":");t.push(parseInt(n[2])),t.push(parseInt(n[0])),t.push(parseInt(n[1]));var s=parseInt(a[0]),d=parseInt(a[1].substring(0,2)),i=a[1].substring(2,1);return"p"==i&&(s+=12),t.push(s),t.push(d),t}var a=n(e.d),s=n(t.d),d=new Date(a[0],a[1],a[2],a[3],a[4]),i=new Date(s[0],s[1],s[2],s[3],s[4]);return i>d?-1:d>i?1:0}e.nextElementSibling?(e.classList.add("active"),e.nextElementSibling.classList.remove("active")):(e.classList.add("active"),e.previousElementSibling.classList.remove("active"));var a=document.querySelectorAll(".messageSort");if(a[0].classList.contains("active"))var s="n";else var s="d";if(a[2].classList.contains("active"))var d="u";else var d="d";for(var i=[],o=document.getElementById("table_messages").children[1],l=0;l<o.children.length;l++)i.push({i:l,n:o.children[l].getAttribute("data-name"),d:o.children[l].getAttribute("data-date")});if("n"==s?i.sort(t):i.sort(n),"d"==d&&i.reverse(),"n"==s)var r="data-name";else var r="data-date";for(var m="",l=0;l<i.length;l++){if("n"==s)var c=i[l].n;else var c=i[l].d;for(var u=0;u<o.children.length;u++)if(c==o.children[u].getAttribute(r)){m+=o.children[u].outerHTML,o.children[u].outerHTML="",u--;break}}o.innerHTML=m,bind_messagesClick()}function getFolder(e){$.post("includes/messageGetFolder",{id:e},function(t){document.getElementById("div_table_messages").innerHTML=t,bind_messagesClick();var n=document.querySelectorAll(".messageSort");switch(n[0].classList.remove("active"),n[1].classList.add("active"),n[2].classList.remove("active"),n[3].classList.add("active"),e){case 0:document.getElementById("button_sortFromTo").innerHTML="From";break;case 1:case 2:document.getElementById("button_sortFromTo").innerHTML="To"}$(".folder").removeClass("active").eq(e).addClass("active")})}function bind_messagesClick(){$("a.messagebtn").click(function(){-1!==document.getElementById("h4_folderName").innerHTML.indexOf("Drafts")?openDraft(this.getAttribute("data-id")):(message_markRead(this.getAttribute("data-id"),this.children[1].children[0].children[0].children[0],this.parentNode.parentNode),viewMessage(this.getAttribute("data-id")))})}function openDraft(e){newMessage(),$.post("includes/messageGet",{ADK_MESSAGE_ID:e},function(t){var n=JSON.parse(t);"HIK"!==document.getElementById("hidden_usergroupcde").value&&(document.getElementById("select_to_username").value=n.toid),document.getElementById("textbox_subject").value=n.title;var a=getWysiIframeBody();a?a.innerHTML=n.content:document.getElementById("textbox_message").value=n.content;var s=document.getElementById("ul_messageattachments");if(n.files.length){for(var d="",i=n.files,o=0;o<i.length;o++)d+='<li><a class="pointer hoverbtn" data-id="'+i[o].id+'" data-desc="'+i[o].desc+'" data-size="'+i[o].size+'" onclick="getFile('+i[o].id+');">'+i[o].name+"</a></li>";s.innerHTML=d}var l=document.createElement("input"),r=document.getElementById("form_newMessage"),m=document.createElement("input");l.setAttribute("type","hidden"),l.setAttribute("name","wasdraft"),l.value="true",m.setAttribute("type","hidden"),m.setAttribute("name","messageid"),m.value=e,r.appendChild(l),r.appendChild(m)})}function loadModal_viewMessage(){document.getElementById("h4_modal_viewMessage").innerHTML=document.getElementById("span_messagesubject").innerHTML,document.getElementById("span_modal_viewMessage_dte").innerHTML=document.getElementById("span_messagedte").innerHTML,document.getElementById("span_modal_viewMessage_message").innerHTML=document.getElementById("span_messagecontent").innerHTML}function deleteMessage(){if(!confirm("Are you sure you want to delete this message?"))return!1;var e=document.getElementById("h4_folderName");$.post("includes/messageDelete.php",{id:document.getElementById("hidden_viewmessageid").value,tofrom:"Sent"===e.innerHTML?"s":"i"},function(){getFolder(-1!==document.getElementById("h4_folderName").innerHTML.indexOf("Sent")?1:0),newMessage()})}function printView(){var e=document.getElementById("span_messagefromusername").innerHTML,t=document.getElementById("span_messagetousername").innerHTML,n=document.getElementById("span_messagesubject").innerHTML,a=document.getElementById("span_messagedte").innerHTML,s=document.getElementById("span_messagecontent").innerHTML,d=window.open(),i="<script>function a(d){var b=document.body.style.fontSize? parseInt(document.body.style.fontSize.replace(/D/g,'')):100;if(b>=50&&b<=150){if(d)b+=10;else b-=10;}if(b<50)b=50;if(b>150)b=150;document.body.style.fontSize=b+'%';}</script>",o='<h3 style="margin-bottom:8px;text-align:center;">The Adirondack Forty-Sixers';o+='<div class="noprint" style="font-size:16px;float:right;"><a href="#" style="text-decoration:none;" onclick="a(0)" title="Zoom out">-</a>&nbsp;|&nbsp;<a href="#" style="text-decoration:none;" onclick="a(1)" title="Zoom in">+</a><br /></div>',o+="</h3>",o+='<img src="img/letterhead.png" style="height:70px;float:right;margin-right:10%;" onload="window.print()" />',o+="",o+="<span>From: "+e+"</span><br />",o+="<span>To: "+t+"</span><br />",o+="<span>Subject: "+n+"</span><br />",o+="<span>Date: "+a+"</span><br />",o+="----------------------------------------<br /><br />",o+='<pre style="word-break:break-word;">'+s+"</pre>",d.document.write(i+o)}function saveDraft(){var e=document.createElement("input"),t=document.getElementById("form_newMessage");e.setAttribute("type","hidden"),e.setAttribute("name","draft"),e.value="true",t.appendChild(e),t.submit()}function saveTemplate(e){""!==editor.composer.element.innerHTML&&"Message"!==editor.composer.element.innerHTML&&""!==document.getElementById("textbox_subject").value&&$.fn.downloader.getFileIndex().indexOf("0")>-1&&$.post("includes/templateSave.php",{ADK_MSG_TMPL_NAME:document.getElementById("textbox_subject").value,ADK_MSG_TMPL_CONTENT:editor.composer.element.innerHTML,isPrivate:e}).done(function(e){var t=JSON.parse(e);populateTemplateList(t),bindTemplates(),document.getElementById("textbox_subject").value="",$(editor.composer.element).empty(),document.getElementById("button_deleteTemplate").style.display="none"}).fail(function(e){alert("Error saving template: "+e)})}function showTemplate(e){destroyEditor();var t=document.getElementById("template_newMessage").innerHTML;document.getElementById("div_messages_main").innerHTML=t,$("#downloader").downloader({desc:!0}),document.getElementById("textbox_subject").value=e.name,document.getElementById("textbox_message").value=e.content,$("#button_updateTemplate, #button_deleteTemplate").each(function(){this.style.display="inline-block",this.setAttribute("data-id",e.id)}),initEditor()}function pasteTemplate(e){var t=document.getElementById("textbox_subject");t||(newMessage(),t=document.getElementById("textbox_subject")),""===t.value&&(t.value=e.name);var n=editor.composer.element;"Message"===n.innerHTML&&(n.innerHTML=""),n.innerHTML+=e.content}function bindTemplates(){$(".template-edit").on("click",function(){getTemplate($(this).data("id"),showTemplate)}),$(".template-paste").on("click",function(){getTemplate($(this).data("id"),function(e){pasteTemplate(e)})})}function getTemplate(e,t){$("#templates_dropdown").parent().removeClass("open");var n=lsTest();n&&localStorage.getItem("msg"+e)?t(JSON.parse(localStorage.getItem("msg"+e))):$.get("includes/templateGet.php?_="+e).done(function(e){var a=JSON.parse(e);n&&localStorage.setItem("msg"+a.id,e),t(a)}).fail(function(e){alert("Error getting folder: "+e)})}function populateTemplateList(e){function t(e){var t=$("<li>"),n=$("<a>"),a=$('<span class="pointer hoverbtn template template-edit" data-id="'+e.id+'" title="Open" data-toggle="tooltip" data-container="body">'),s=$('<span class="glyphicon glyphicon-pencil"></span>'),d=$('<span class="pointer hoverbtn template template-paste" data-id="'+e.id+'" title="Paste into Message" data-toggle="tooltip" data-container="body">'),i=$('<span class="glyphicon glyphicon-paste"></span>'),o=$("<span>"+e.name+"</span>");return a.append(s),d.append(i),n.append(a,d,o),t.append(n),t}$("#ul_templates li").each(function(){this.children.length&&this.children[0].children.length&&-1!==this.children[0].children[0].className.indexOf("template")&&this.parentNode.removeChild(this)});var n=$(".dropdown-header-public");e["public"].forEach(function(e){var a=t(e);n.after(a),n=a}),n=$(".dropdown-header-private"),e["private"].forEach(function(e){var a=t(e);n.after(a),n=a})}function destroyEditor(){if("undefined"!=typeof editor)try{editor.destroy()}catch(e){}}function initEditor(){window.editor=new wysihtml.Editor("textbox_message",{toolbar:"wysihtml-toolbar",parserRules:wysihtmlParserRules,stylesheets:"css/wysihtml.css"})}$(document).ready(function(){function e(e){var t=JSON.parse(e);populateTemplateList(t),bindTemplates(),document.getElementById("textbox_subject").value="",$(editor.composer.element).empty(),document.getElementById("button_updateTemplate").style.display="none",document.getElementById("button_deleteTemplate").style.display="none"}if(document.getElementById("hidden_newMessage")){var t=document.getElementById("template_newMessage").innerHTML;document.getElementById("div_messages_main").innerHTML=t,$("#downloader").downloader({desc:!0}),populateNewMessage(),initEditor()}if(bind_messagesClick(),$(".messageSort").click(function(){sortMessages(this)}),$("#div_table_messages").on("click",".message-filter a",function(){if(-1===this.className.indexOf("active")){$(".message-filter a.active").removeClass("active"),this.classList.add("active");var e;-1!==this.className.indexOf("unread")?e=1:-1!==this.className.indexOf("read")&&(e=2),e?$("#table_messages tr").each(function(){1===e?this.style.display="true"===this.getAttribute("data-isread")?"none":"table-row":this.style.display="true"===this.getAttribute("data-isread")?"table-row":"none"}):$("#table_messages tr").css("display","table-row"),$("#table_messages tr:visible").each(function(e){e%2===0?this.style["background-color"]="#ededed":this.style["background-color"]="#dce1f9"})}}),$("#select_to_username").change(function(){document.getElementById("hidden_touserid").value=this.value}),bindTemplates(),$(document).on("click",".saveTemplate",function(){saveTemplate(this.className.indexOf("private")>-1)}),$(document).on("click","#button_updateTemplate",function(){if(""!==editor.composer.element.innerHTML&&"Message"!==editor.composer.element.innerHTML&&""!==document.getElementById("textbox_subject").value&&$.fn.downloader.getFileIndex().indexOf("0")>-1){var e=$(this).data("id");$.post("includes/templateUpdate.php",{ADK_MSG_TMPL_ID:e,ADK_MSG_TMPL_NAME:document.getElementById("textbox_subject").value,ADK_MSG_TMPL_CONTENT:editor.composer.element.innerHTML}).done(function(t){var n=JSON.parse(t);populateTemplateList(n),bindTemplates(),cancelMessage(),lsTest()&&localStorage.removeItem("msg"+e)}).fail(function(e){alert("There was an error updating the template: "+e)})}}),$(document).on("click","#button_deleteTemplate",function(){$.post("includes/templateDelete.php",{id:$(this).data("id")}).done(function(t){e(t)}).fail(function(e){alert("There was an error deleting the template: "+e)})}),$_GET("m")){var n;switch($_GET("m")){case"s":n=$('<span class="font-italic error message-notify message-notify-sent">Message sent successfully</span>');break;case"d":n=$('<span class="font-italic error message-notify message-notify-draft">Draft saved successfully</span>')}$(".content-wrapper").prepend(n),$("#table_messages, .messages-menu a, .messages-menu input, .messages-menu button").one("click",function(){n.remove()})}});